{% extends 'base.html' %}

{% block title %}Student Registration{% endblock %}

{% block content %}
<div class="registration-container">
  <h2 class="form-title">üìù Student Registration</h2>
  <p class="form-subtitle">Fill in your details to register for the quiz</p>

  <form method="post" class="registration-form" id="registration-form">
    {% csrf_token %}

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
      <div class="alert alert-error">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="form-grid">
      <div class="form-group">
        <label for="id_name">Full Name <span class="required">*</span></label>
        {{ form.name }}
        <div class="validation-message" id="name-validation"></div>
        {{ form.name.errors }}
      </div>

      <div class="form-group">
        <label for="id_phone">Phone Number <span class="required">*</span></label>
        {{ form.phone }}
        <div class="validation-message" id="phone-validation"></div>
        {{ form.phone.errors }}
      </div>

      <div class="form-group">
        <label for="id_email">Email Address <span class="required">*</span></label>
        {{ form.email }}
        <div class="validation-message" id="email-validation"></div>
        {{ form.email.errors }}
      </div>
    </div>

    <div class="form-group full-width">
      <label for="id_password">Password <span class="required">*</span></label>
      {{ form.password }}
      <div class="validation-message" id="password-validation"></div>
      <div id="password-strength" class="password-strength"></div>
      <div class="help-text">At least 6 characters with letters and numbers recommended</div>
      {{ form.password.errors }}
    </div>

    <button type="submit" class="btn-submit">
      <span class="btn-icon">‚úì</span> Register Account
    </button>

    <p class="form-footer">
      Already registered? <a href="{% url 'student_login' %}" class="link-primary">Login here</a>
    </p>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('registration-form');
    const nameField = document.getElementById('id_name');
    const phoneField = document.getElementById('id_phone');
    const emailField = document.getElementById('id_email');
    const passwordField = document.getElementById('id_password');

    // Form submission validation
    if (form) {
      form.addEventListener('submit', function(e) {
        let hasErrors = false;
        
        // Validate required fields before submit
        if (nameField && !nameField.value.trim()) {
          showValidation('name', '‚ö†Ô∏è Name is required', true);
          addFieldBorder(nameField, true);
          hasErrors = true;
        }
        
        if (phoneField && !phoneField.value.trim()) {
          showValidation('phone', '‚ö†Ô∏è Phone number is required', true);
          addFieldBorder(phoneField, true);
          hasErrors = true;
        } else if (phoneField && !/^\d{10}$/.test(phoneField.value.trim())) {
          showValidation('phone', '‚ö†Ô∏è Phone must be exactly 10 digits', true);
          addFieldBorder(phoneField, true);
          hasErrors = true;
        }
        
        if (emailField && !emailField.value.trim()) {
          showValidation('email', '‚ö†Ô∏è Email is required', true);
          addFieldBorder(emailField, true);
          hasErrors = true;
        }
        
        if (passwordField && !passwordField.value.trim()) {
          showValidation('password', '‚ö†Ô∏è Password is required', true);
          addFieldBorder(passwordField, true);
          hasErrors = true;
        } else if (passwordField && passwordField.value.trim().length < 6) {
          showValidation('password', '‚ö†Ô∏è Password must be at least 6 characters', true);
          addFieldBorder(passwordField, true);
          hasErrors = true;
        }
        
        // If there are validation errors, prevent submission and scroll to first error
        if (hasErrors) {
          e.preventDefault();
          showAlert(
            'Validation Error',
            'Please fill in all required fields correctly before submitting.',
            'error'
          );
          const firstError = document.querySelector('.validation-error');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return false;
        }
        
        // Allow form submission if no errors
        return true;
      });
    }

    // Validation helper functions
    function showValidation(fieldId, message, isError) {
      const validationDiv = document.getElementById(fieldId + '-validation');
      if (validationDiv) {
        if (message) {
          validationDiv.textContent = message;
          validationDiv.className = 'validation-message ' + (isError ? 'validation-error' : 'validation-success');
        } else {
          validationDiv.textContent = '';
          validationDiv.className = 'validation-message';
        }
      }
    }

    function addFieldBorder(field, isError) {
      if (field) {
        if (isError) {
          field.classList.remove('input-success');
          field.classList.add('input-error');
        } else if (field.value.trim()) {
          field.classList.remove('input-error');
          field.classList.add('input-success');
        } else {
          field.classList.remove('input-error', 'input-success');
        }
      }
    }
    
    // Show alert message
    function showAlert(title, message, type = 'error') {
      // Remove any existing alerts
      const existingAlert = document.querySelector('.form-alert');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `form-alert form-alert-${type}`;
      alertDiv.innerHTML = `
        <div class="form-alert-icon">${type === 'error' ? '‚ö†Ô∏è' : '‚úì'}</div>
        <div class="form-alert-content">
          <div class="form-alert-title">${title}</div>
          <div class="form-alert-message">${message}</div>
        </div>
        <button class="form-alert-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.style.animation = 'slideInRight 0.4s ease-out reverse';
          setTimeout(() => alertDiv.remove(), 400);
        }
      }, 5000);
    }

    // Name validation
    if (nameField) {
      nameField.addEventListener('blur', function() {
        if (!this.value.trim()) {
          showValidation('name', '‚ö†Ô∏è Name is required', true);
          addFieldBorder(this, true);
        } else if (this.value.trim().length < 2) {
          showValidation('name', '‚ö†Ô∏è Name must be at least 2 characters', true);
          addFieldBorder(this, true);
        } else {
          showValidation('name', '‚úì Looks good', false);
          addFieldBorder(this, false);
        }
      });

      nameField.addEventListener('input', function() {
        if (this.value.trim().length >= 2) {
          showValidation('name', '‚úì Looks good', false);
          addFieldBorder(this, false);
        }
      });
    }

    // Phone validation
    if (phoneField) {
      phoneField.addEventListener('blur', function() {
        const phoneValue = this.value.trim();
        if (!phoneValue) {
          showValidation('phone', '‚ö†Ô∏è Phone number is required', true);
          addFieldBorder(this, true);
        } else if (!/^\d{10}$/.test(phoneValue)) {
          showValidation('phone', '‚ö†Ô∏è Phone must be exactly 10 digits', true);
          addFieldBorder(this, true);
        } else {
          showValidation('phone', '‚úì Valid phone number', false);
          addFieldBorder(this, false);
        }
      });

      phoneField.addEventListener('input', function() {
        const phoneValue = this.value.trim();
        if (/^\d{10}$/.test(phoneValue)) {
          showValidation('phone', '‚úì Valid phone number', false);
          addFieldBorder(this, false);
        } else if (phoneValue.length > 0) {
          showValidation('phone', `${phoneValue.length}/10 digits`, true);
        }
      });
    }

    // Email validation
    if (emailField) {
      emailField.addEventListener('blur', function() {
        const emailValue = this.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailValue) {
          showValidation('email', '‚ö†Ô∏è Email is required', true);
          addFieldBorder(this, true);
        } else if (!emailRegex.test(emailValue)) {
          showValidation('email', '‚ö†Ô∏è Please enter a valid email address', true);
          addFieldBorder(this, true);
        } else {
          showValidation('email', '‚úì Valid email', false);
          addFieldBorder(this, false);
        }
      });

      emailField.addEventListener('input', function() {
        const emailValue = this.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(emailValue)) {
          showValidation('email', '‚úì Valid email', false);
          addFieldBorder(this, false);
        }
      });
    }

    // Password validation
    if (passwordField) {
      passwordField.addEventListener('blur', function() {
        const passwordValue = this.value.trim();
        if (!passwordValue) {
          showValidation('password', '‚ö†Ô∏è Password is required', true);
          addFieldBorder(this, true);
        } else if (passwordValue.length < 6) {
          showValidation('password', '‚ö†Ô∏è Password must be at least 6 characters', true);
          addFieldBorder(this, true);
        } else {
          showValidation('password', '‚úì Valid password', false);
          addFieldBorder(this, false);
        }
      });

      passwordField.addEventListener('input', function() {
        const passwordValue = this.value.trim();
        if (passwordValue.length >= 6) {
          showValidation('password', '‚úì Valid password', false);
          addFieldBorder(this, false);
        }
      });
    }

    // Password strength indicator
    const strengthDiv = document.getElementById('password-strength');
    
    if (passwordField && strengthDiv) {
      passwordField.addEventListener('input', function() {
        const pwd = this.value;
        let strength = 0;
        let feedback = '';
        let color = '';
        let barWidth = 0;
        
        if (pwd.length === 0) {
          strengthDiv.innerHTML = '';
          return;
        }
        
        // Length check
        if (pwd.length >= 6) strength += 1;
        if (pwd.length >= 10) strength += 1;
        
        // Has letters
        if (/[a-zA-Z]/.test(pwd)) strength += 1;
        
        // Has numbers
        if (/\d/.test(pwd)) strength += 1;
        
        // Has special characters
        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd)) strength += 1;
        
        // Has mixed case
        if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) strength += 1;
        
        if (strength <= 2) {
          feedback = '‚ùå Weak';
          color = '#d32f2f';
          barWidth = 33;
        } else if (strength <= 4) {
          feedback = '‚ö†Ô∏è Medium';
          color = '#f57c00';
          barWidth = 66;
        } else {
          feedback = '‚úÖ Strong';
          color = '#388e3c';
          barWidth = 100;
        }
        
        strengthDiv.innerHTML = `
          <div class="strength-bar">
            <div class="strength-bar-fill" style="width: ${barWidth}%; background-color: ${color};"></div>
          </div>
          <span class="strength-label" style="color: ${color};">${feedback}</span>
        `;
      });
    }
  });
</script>

{% endblock %}
